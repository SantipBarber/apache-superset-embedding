<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Superset Dashboard Embedder - Genérico</title>
    
    <!-- Cargar SDK de Superset -->
    <script src="https://unpkg.com/@superset-ui/embedded-sdk@0.2.0"></script>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 300;
        }
        
        .header p {
            margin: 8px 0 0 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .config-section {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border: 1px solid #e1e5e9;
        }
        
        .config-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
            font-size: 14px;
        }
        
        input[type="text"], 
        input[type="password"], 
        input[type="url"], 
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e1e5e9;
        }
        
        .toolbar {
            background-color: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .toolbar select {
            min-width: 250px;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .status {
            margin-left: auto;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        
        .iframe-container {
            position: relative;
            width: 100%;
            height: 650px;
            border: none;
            background-color: #f8f9fa;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 10;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-panel {
            padding: 20px;
            background-color: #e8f4f8;
            border-left: 4px solid #17a2b8;
            margin: 25px 0;
            border-radius: 0 6px 6px 0;
        }
        
        .info-panel.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        
        .info-panel.success {
            background-color: #d4edda;
            border-left-color: #28a745;
        }
        
        .info-panel h3 {
            margin: 0 0 15px 0;
            color: #0c5460;
            font-size: 18px;
        }
        
        .info-panel.warning h3 {
            color: #856404;
        }
        
        .info-panel.success h3 {
            color: #155724;
        }
        
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .debug-panel pre {
            margin: 0;
            white-space: pre-wrap;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .environment-detector {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar select {
                min-width: auto;
            }
            
            .status {
                margin-left: 0;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 Superset Dashboard Embedder</h1>
        <p>Herramienta genérica para integrar dashboards de Apache Superset mediante embedding dinámico</p>
    </div>

    <!-- Detector de entorno -->
    <div class="environment-detector">
        <strong>Entorno detectado:</strong> <span id="detected-environment">Detectando...</span>
    </div>

    <!-- Configuración dinámica -->
    <div class="config-section">
        <h3>🔧 Configuración de Conexión</h3>
        <div class="form-row">
            <div class="form-group">
                <label for="superset-url-input">URL de Superset:</label>
                <input type="url" id="superset-url-input" placeholder="http://localhost:8088" />
                <small style="color: #6c757d;">Incluye protocolo (http:// o https://)</small>
            </div>
            <div class="form-group">
                <label for="username-input">Usuario Administrador:</label>
                <input type="text" id="username-input" placeholder="admin" value="admin" />
            </div>
            <div class="form-group">
                <label for="password-input">Contraseña:</label>
                <input type="password" id="password-input" placeholder="admin" value="admin" />
            </div>
        </div>
        <button class="btn" onclick="connectAndLoadDashboards()" id="connect-btn">
            🔗 Conectar y Cargar Dashboards
        </button>
    </div>

    <!-- Estadísticas de conexión -->
    <div id="connection-stats" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-dashboards">0</div>
                <div class="stat-label">Total Dashboards</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="embedded-dashboards">0</div>
                <div class="stat-label">Con Embedding</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="response-time">0ms</div>
                <div class="stat-label">Tiempo de Respuesta</div>
            </div>
        </div>
    </div>

    <div class="info-panel">
        <h3>📋 Estado de la Conexión</h3>
        <ul>
            <li><strong>URL Base:</strong> <span id="current-url">No conectado</span></li>
            <li><strong>Estado:</strong> <span id="connection-status">Desconectado</span></li>
            <li><strong>Método:</strong> Detección automática de UUIDs de embedding</li>
            <li><strong>Autenticación:</strong> JWT + Guest Tokens automáticos</li>
        </ul>
    </div>

    <!-- Debug info -->
    <div id="debug-info" class="debug-panel" style="display: none;"></div>

    <div class="container">
        <div class="toolbar">
            <label for="dashboard-select">📊 Dashboard:</label>
            <select id="dashboard-select">
                <option value="">-- Primero conecta a Superset --</option>
            </select>
            <button class="btn" id="load-btn" onclick="loadDashboard()" disabled>
                Cargar Dashboard
            </button>
            <button class="btn" id="refresh-btn" onclick="refreshDashboards()" disabled>
                🔄 Actualizar Lista
            </button>
            <div class="status" id="status">Listo para conectar</div>
        </div>

        <div class="iframe-container">
            <div class="loading-overlay" id="loading-overlay" style="display: none;">
                <div class="loading-spinner"></div>
                <p><strong>Cargando dashboard de Superset...</strong></p>
                <small>Esto puede tomar unos segundos</small>
            </div>
            <div id="superset-container" style="width: 100%; height: 650px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #6c757d;">
                <div style="text-align: center;">
                    <h3>📊 Selecciona un dashboard para comenzar</h3>
                    <p>Conecta a tu instancia de Superset y selecciona un dashboard con embedding habilitado</p>
                </div>
            </div>
        </div>
    </div>

    <div class="info-panel success" style="margin-top: 25px;">
        <h3>✅ Funcionalidades Implementadas</h3>
        <ul>
            <li>🔍 <strong>Detección automática de entorno</strong> - Detecta localhost vs producción</li>
            <li>🔗 <strong>Conexión dinámica</strong> - Configuración flexible de URL y credenciales</li>
            <li>📊 <strong>Carga automática de dashboards</strong> - Obtiene dashboards desde la API</li>
            <li>🔐 <strong>Verificación de embedding</strong> - Solo muestra dashboards con embedding habilitado</li>
            <li>🎯 <strong>Guest tokens automáticos</strong> - Generación transparente de permisos</li>
            <li>📱 <strong>Diseño responsive</strong> - Funciona en móviles y tablets</li>
            <li>🐛 <strong>Debug avanzado</strong> - Información detallada para troubleshooting</li>
            <li>📈 <strong>Métricas en tiempo real</strong> - Estadísticas de conexión y rendimiento</li>
        </ul>
    </div>

    <div class="info-panel warning">
        <h3>⚙️ Requisitos de Configuración</h3>
        <p><strong>Para que esta herramienta funcione correctamente:</strong></p>
        <ol>
            <li><strong>Superset configurado:</strong> Instancia accesible con credenciales admin</li>
            <li><strong>CORS habilitado:</strong> Dominio actual agregado a CORS_OPTIONS</li>
            <li><strong>Embedding habilitado:</strong> Al menos un dashboard con embedding configurado</li>
            <li><strong>Dominios permitidos:</strong> URL actual en la lista de dominios permitidos del dashboard</li>
        </ol>
        <p><strong>Usa los scripts auxiliares para configuración automática.</strong></p>
    </div>

    <script>
        // Variables globales
        let config = {
            supersetUrl: '',
            username: '',
            password: '',
            accessToken: null,
            dashboards: [],
            environment: 'development'
        };
        
        // Elementos DOM
        const elements = {
            dashboardSelect: document.getElementById('dashboard-select'),
            loadBtn: document.getElementById('load-btn'),
            refreshBtn: document.getElementById('refresh-btn'),
            connectBtn: document.getElementById('connect-btn'),
            statusEl: document.getElementById('status'),
            loadingOverlay: document.getElementById('loading-overlay'),
            debugInfo: document.getElementById('debug-info'),
            connectionStats: document.getElementById('connection-stats'),
            supersetUrlInput: document.getElementById('superset-url-input'),
            usernameInput: document.getElementById('username-input'),
            passwordInput: document.getElementById('password-input')
        };
        
        // Detector de entorno
        function detectEnvironment() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            const port = window.location.port;
            
            let environment = 'production';
            let defaultSuperset = 'http://localhost:8088';
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                environment = 'development';
                defaultSuperset = 'http://localhost:8088';
            } else {
                // En producción, intentar detectar la IP local común
                defaultSuperset = `http://192.168.1.100:8088`;
            }
            
            config.environment = environment;
            elements.supersetUrlInput.value = defaultSuperset;
            
            document.getElementById('detected-environment').textContent = 
                `${environment} (${hostname}:${port || '80'})`;
            
            return environment;
        }
        
        // Funciones de utilidad
        function setStatus(message, type = 'success') {
            elements.statusEl.textContent = message;
            elements.statusEl.className = `status ${type}`;
        }
        
        function showLoading(show) {
            elements.loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        function showDebug(data, title = 'Debug Info') {
            elements.debugInfo.style.display = 'block';
            elements.debugInfo.innerHTML = `
                <h4>${title}</h4>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }
        
        function updateStats(total, embedded, responseTime) {
            document.getElementById('total-dashboards').textContent = total;
            document.getElementById('embedded-dashboards').textContent = embedded;
            document.getElementById('response-time').textContent = `${responseTime}ms`;
            elements.connectionStats.style.display = 'block';
        }
        
        function validateConfig() {
            const url = elements.supersetUrlInput.value.trim();
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value.trim();
            
            if (!url || !username || !password) {
                throw new Error('Todos los campos son obligatorios');
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                throw new Error('La URL debe incluir el protocolo (http:// o https://)');
            }
            
            config.supersetUrl = url;
            config.username = username;
            config.password = password;
            
            return true;
        }
        
        // Función para conectar y cargar dashboards
        async function connectAndLoadDashboards() {
            try {
                validateConfig();
            } catch (error) {
                setStatus(error.message, 'error');
                return;
            }
            
            elements.connectBtn.disabled = true;
            setStatus('Conectando...', 'loading');
            
            const startTime = Date.now();
            
            try {
                // Verificar conectividad
                const healthResponse = await fetch(`${config.supersetUrl}/health`);
                if (!healthResponse.ok) {
                    throw new Error(`Superset no está disponible (${healthResponse.status})`);
                }
                
                const responseTime = Date.now() - startTime;
                
                // Actualizar UI
                document.getElementById('current-url').textContent = config.supersetUrl;
                document.getElementById('connection-status').textContent = 'Conectado ✅';
                
                // Cargar dashboards
                await refreshDashboards();
                
                // Habilitar controles
                elements.refreshBtn.disabled = false;
                updateStats(config.dashboards.length, 
                           config.dashboards.filter(d => d.embeddingUuid).length, 
                           responseTime);
                
                setStatus('Conexión exitosa', 'success');
                
            } catch (error) {
                setStatus(`Error de conexión: ${error.message}`, 'error');
                document.getElementById('connection-status').textContent = 'Error de conexión ❌';
                console.error('Error de conexión:', error);
                showDebug({ error: error.message, config }, 'Error de Conexión');
            } finally {
                elements.connectBtn.disabled = false;
            }
        }
        
        // Obtener token de acceso
        async function getAccessToken() {
            try {
                const response = await fetch(`${config.supersetUrl}/api/v1/security/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: config.username,
                        password: config.password,
                        provider: 'db'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error de login (${response.status}): ${errorData.message || 'Credenciales inválidas'}`);
                }

                const data = await response.json();
                config.accessToken = data.access_token;
                return config.accessToken;
            } catch (error) {
                console.error('Error en login:', error);
                throw error;
            }
        }
        
        // Obtener lista de dashboards
        async function getDashboards() {
            try {
                if (!config.accessToken) {
                    await getAccessToken();
                }
                
                const response = await fetch(`${config.supersetUrl}/api/v1/dashboard/?q=(page:0,page_size:100)`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.accessToken}`,
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`Error obteniendo dashboards (${response.status})`);
                }

                const data = await response.json();
                config.dashboards = data.result.filter(dashboard => dashboard.published);
                
                return config.dashboards;
            } catch (error) {
                console.error('Error obteniendo dashboards:', error);
                throw error;
            }
        }
        
        // Obtener el embedding UUID para un dashboard
        async function getEmbeddingUuid(dashboardId) {
            try {
                const response = await fetch(`${config.supersetUrl}/api/v1/dashboard/${dashboardId}/embedded`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${config.accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.result && data.result.uuid ? data.result.uuid : null;
                } else if (response.status === 404) {
                    // Dashboard no tiene embedding habilitado
                    return null;
                } else {
                    console.warn(`Error obteniendo embedding para dashboard ${dashboardId}:`, response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error obteniendo embedding UUID:', error);
                return null;
            }
        }
        
        // Actualizar lista de dashboards en el select
        async function updateDashboardSelect() {
            elements.dashboardSelect.innerHTML = '<option value="">-- Selecciona un dashboard --</option>';
            
            let embeddedCount = 0;
            
            // Verificar cuáles tienen embedding habilitado
            for (const dashboard of config.dashboards) {
                const embeddingUuid = await getEmbeddingUuid(dashboard.id);
                dashboard.embeddingUuid = embeddingUuid;
                
                const option = document.createElement('option');
                option.value = dashboard.id;
                option.dataset.dashboardUuid = dashboard.uuid;
                option.dataset.embeddingUuid = embeddingUuid || '';
                
                if (embeddingUuid) {
                    option.textContent = `✅ ${dashboard.dashboard_title}`;
                    embeddedCount++;
                } else {
                    option.textContent = `❌ ${dashboard.dashboard_title} (sin embedding)`;
                    option.disabled = true;
                }
                
                elements.dashboardSelect.appendChild(option);
            }
            
            elements.loadBtn.disabled = embeddedCount === 0;
            
            if (embeddedCount === 0) {
                setStatus('No hay dashboards con embedding habilitado', 'error');
                showDebug({
                    message: 'Para habilitar embedding, ve a Superset > Dashboard > Settings > Embed dashboard',
                    dashboards: config.dashboards.map(d => ({
                        id: d.id,
                        title: d.dashboard_title,
                        hasEmbedding: !!d.embeddingUuid
                    }))
                }, 'Configuración de Embedding Requerida');
            } else {
                setStatus(`${embeddedCount} dashboards listos para usar`, 'success');
            }
        }
        
        // Obtener guest token
        async function getGuestToken(embeddingUuid) {
            try {
                if (!config.accessToken) {
                    await getAccessToken();
                }
                
                const response = await fetch(`${config.supersetUrl}/api/v1/security/guest_token/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.accessToken}`,
                    },
                    body: JSON.stringify({
                        user: {
                            username: 'guest_user',
                            first_name: 'Guest',
                            last_name: 'User'
                        },
                        resources: [{
                            type: 'dashboard',
                            id: embeddingUuid
                        }],
                        rls: []
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error creando guest token (${response.status}): ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                return data.token;
            } catch (error) {
                console.error('Error obteniendo guest token:', error);
                throw error;
            }
        }
        
        // Cargar dashboard usando el SDK
        async function loadDashboard() {
            const selectedOption = elements.dashboardSelect.selectedOptions[0];
            if (!selectedOption || !selectedOption.value) {
                setStatus('Selecciona un dashboard', 'error');
                return;
            }
            
            const dashboardId = selectedOption.value;
            const dashboardUuid = selectedOption.dataset.dashboardUuid;
            const embeddingUuid = selectedOption.dataset.embeddingUuid;
            const dashboardTitle = selectedOption.textContent.replace(/[✅❌] /, '');
            
            if (!embeddingUuid) {
                setStatus('Este dashboard no tiene embedding habilitado', 'error');
                return;
            }
            
            try {
                showLoading(true);
                setStatus('Generando permisos...', 'loading');
                
                // Limpiar contenedor anterior
                const container = document.getElementById('superset-container');
                container.innerHTML = '';
                
                // Obtener guest token
                const guestToken = await getGuestToken(embeddingUuid);
                
                setStatus('Incrustando dashboard...', 'loading');
                
                showDebug({
                    dashboard: {
                        id: dashboardId,
                        title: dashboardTitle,
                        dashboardUuid,
                        embeddingUuid
                    },
                    guestToken: guestToken.substring(0, 50) + '...'
                }, 'Información de Embedding');
                
                // Usar el SDK con el embedding UUID
                await supersetEmbeddedSdk.embedDashboard({
                    id: embeddingUuid,
                    supersetDomain: config.supersetUrl,
                    mountPoint: container,
                    fetchGuestToken: () => guestToken,
                    dashboardUiConfig: {
                        hideTitle: false,
                        hideTab: false,
                        hideChartControls: false,
                        hideFilters: false
                    }
                });
                
                // Ajustar tamaño del iframe
                setTimeout(() => {
                    const iframe = container.querySelector('iframe');
                    if (iframe) {
                        iframe.style.width = '100%';
                        iframe.style.height = '650px';
                        iframe.style.border = 'none';
                    }
                }, 1000);
                
                showLoading(false);
                setStatus(`Dashboard cargado: ${dashboardTitle}`, 'success');
                
            } catch (error) {
                showLoading(false);
                setStatus(`Error: ${error.message}`, 'error');
                console.error('Error cargando dashboard:', error);
                
                showDebug({
                    error: error.message,
                    dashboard: { 
                        dashboardId, 
                        dashboardUuid, 
                        embeddingUuid 
                    },
                    stack: error.stack
                }, 'Error de Carga');
            }
        }
        
        // Actualizar lista de dashboards
        async function refreshDashboards() {
            try {
                setStatus('Actualizando lista...', 'loading');
                elements.loadBtn.disabled = true;
                
                await getDashboards();
                await updateDashboardSelect();
                
                const totalDashboards = config.dashboards.length;
                const embeddedDashboards = config.dashboards.filter(d => d.embeddingUuid).length;
                
                updateStats(totalDashboards, embeddedDashboards, 0);
                setStatus(`${totalDashboards} dashboards encontrados (${embeddedDashboards} con embedding)`, 'success');
                
            } catch (error) {
                setStatus(`Error: ${error.message}`, 'error');
                console.error('Error actualizando dashboards:', error);
            }
        }
        
        // Event listeners
        elements.dashboardSelect.addEventListener('change', function() {
            const selectedOption = this.selectedOptions[0];
            elements.loadBtn.disabled = !this.value || !selectedOption.dataset.embeddingUuid;
        });
        
        // Eventos de teclado para conectar con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        connectAndLoadDashboards();
                    }
                });
            });
            
            // Detectar entorno al cargar
            detectEnvironment();
        });
        
        // Funciones de utilidad adicionales
        function exportConfiguration() {
            const configToExport = {
                supersetUrl: config.supersetUrl,
                username: config.username,
                environment: config.environment,
                dashboards: config.dashboards.map(d => ({
                    id: d.id,
                    title: d.dashboard_title,
                    dashboardUuid: d.uuid,
                    embeddingUuid: d.embeddingUuid,
                    hasEmbedding: !!d.embeddingUuid
                }))
            };
            
            const dataStr = JSON.stringify(configToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type:'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'superset-config.json';
            link.click();
        }
        
        // Funciones de diagnóstico
        function runDiagnostics() {
            return {
                environment: config.environment,
                currentUrl: window.location.href,
                supersetUrl: config.supersetUrl,
                hasToken: !!config.accessToken,
                dashboardCount: config.dashboards.length,
                embeddedCount: config.dashboards.filter(d => d.embeddingUuid).length,
                browserInfo: {
                    userAgent: navigator.userAgent,
                    hostname: window.location.hostname,
                    protocol: window.location.protocol
                }
            };
        }
        
        // Exponer funciones para depuración
        window.supersetEmbedder = {
            config,
            exportConfiguration,
            runDiagnostics,
            showDebug,
            elements
        };
    </script>
</body>
</html>