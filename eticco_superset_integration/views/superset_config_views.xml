<?xml version="1.0" encoding="utf-8"?>
<odoo>
   
    <!-- ================================= -->
    <!-- CONFIGURACIÓN MEJORADA EN SETTINGS -->
    <!-- ================================= -->
   
    <record id="res_config_settings_view_form_inherit_superset" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.superset</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <app data-string="Superset Integration" string="Superset Integration" name="eticco_superset_integration" groups="eticco_superset_integration.group_superset_manager">
                   
                    <block title="Conexión a Superset" help="Configure la conexión con el servidor Apache Superset">
                        <setting string="Servidor Superset" help="Configure la URL y credenciales del servidor">
                            <div class="row">
                                <div class="col-12">
                                    <field name="superset_url" placeholder="http://192.168.1.137:8088" class="o_light_label"/>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-6">
                                    <label for="superset_username" class="o_light_label">Usuario</label>
                                    <field name="superset_username" placeholder="admin"/>
                                </div>
                                <div class="col-6">
                                    <label for="superset_password" class="o_light_label">Contraseña</label>
                                    <field name="superset_password" password="True" placeholder="admin"/>
                                </div>
                            </div>
                        </setting>
                       
                        <setting string="Configuración Avanzada">
                            <div class="row">
                                <div class="col-4">
                                    <label for="superset_timeout" class="o_light_label">Timeout (seg)</label>
                                    <field name="superset_timeout"/>
                                </div>
                                <div class="col-4">
                                    <div class="o_checkbox_optional_field">
                                        <field name="superset_cache_tokens"/>
                                        <label for="superset_cache_tokens">Cache de tokens</label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="o_checkbox_optional_field">
                                        <field name="superset_debug_mode"/>
                                        <label for="superset_debug_mode">Modo debug</label>
                                    </div>
                                </div>
                            </div>
                        </setting>
                    </block>

                    <block title="Estado y Diagnósticos">
                        <setting string="Pruebas de Conexión">
                            <div class="d-flex flex-wrap gap-2">
                                <button name="test_superset_connection"
                                        string="Probar Conexión"
                                        type="object"
                                        class="btn-primary"/>
                                <button name="open_superset_dashboards"
                                        string="Ver Dashboards"
                                        type="object"
                                        class="btn-secondary"/>
                                <button name="clear_superset_cache"
                                        string="Limpiar Cache"
                                        type="object"
                                        class="btn-light"/>
                            </div>
                            <div class="text-muted mt-2">
                                <span>Estado: </span>
                                <field name="superset_connection_status" readonly="1" class="fw-bold"/>
                            </div>
                            <div class="row mt-2" invisible="superset_dashboards_count == 0">
                                <div class="col-6 text-muted">
                                    <small>Total dashboards: </small>
                                    <field name="superset_dashboards_count" readonly="1" class="fw-bold text-primary"/>
                                </div>
                                <div class="col-6 text-muted">
                                    <small>Con embedding: </small>
                                    <field name="superset_embedding_count" readonly="1" class="fw-bold text-success"/>
                                </div>
                            </div>
                        </setting>
                    </block>
                   
                    <block title="Configuración de Menús" help="Configure dónde aparecerán los dashboards en Odoo">
                        <setting string="Crear Menú de Analytics" help="Crea automáticamente el menú para acceder a dashboards">
                            <div class="row">
                                <div class="col-6">
                                    <label for="superset_menu_parent" class="o_light_label">Menú padre</label>
                                    <field name="superset_menu_parent" 
                                           options="{'no_create': True, 'no_edit': True}"/>
                                </div>
                                <div class="col-6">
                                    <label for="superset_menu_name" class="o_light_label">Nombre del menú</label>
                                    <field name="superset_menu_name" placeholder="Analytics"/>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button name="create_dashboard_menu"
                                        string="Crear Menú"
                                        type="object"
                                        class="btn-success"
                                        icon="oi-arrow-right"/>
                            </div>
                        </setting>
                    </block>
                   
                </app>
            </xpath>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- VISOR DE DASHBOARDS MEJORADO    -->
    <!-- ================================= -->
   
  <record id="view_superset_dashboard_viewer_form" model="ir.ui.view">
        <field name="name">superset.dashboard.viewer.form</field>
        <field name="model">superset.dashboard.viewer</field>
        <field name="arch" type="xml">
            <form string="Dashboard Superset" create="false" edit="false" delete="false">
                <header>
                    <button string="🔗 Abrir en Superset"
                            name="action_open_in_superset"
                            type="object"
                            class="btn-primary"/>
                </header>
               
                <sheet>
                    <!-- DEBUG: Mostrar información del viewer -->
                    <group string="🔍 DEBUG - Dashboard Viewer" invisible="not dashboard_uuid">
                        <field name="dashboard_uuid" readonly="1" string="UUID del Dashboard"/>
                        <field name="dashboard_title" readonly="1" string="Título"/>
                    </group>
                   
                    <!-- Dashboard embebido via iframe -->
                    <div invisible="not dashboard_uuid">
                        <h3>📊 Dashboard: <field name="dashboard_title" readonly="1" nolabel="1"/></h3>
                        <!-- Botón para abrir dashboard en nueva ventana -->
                        <div class="text-center mt-3">
                            <button type="object"
                                    name="open_dashboard_window"
                                    string="🚀 Abrir Dashboard"
                                    class="btn btn-primary btn-lg"/>
                        </div>
                        <div class="text-muted text-center mt-2">
                            <small>El dashboard se abrirá en la misma ventana</small>
                        </div>
                    </div>
                   
                    <!-- Mensaje si no hay UUID -->
                    <div class="alert alert-warning" invisible="dashboard_uuid">
                        <h5>⚠️ No hay dashboard configurado</h5>
                        <p>Este visor necesita recibir un dashboard_uuid.</p>
                    </div>
                   
                </sheet>
            </form>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- SELECTOR COMPLETO DE DASHBOARD      -->
    <!-- ================================= -->
   
   <record id="view_superset_dashboard_selector_form" model="ir.ui.view">
        <field name="name">superset.dashboard.selector.form</field>
        <field name="model">superset.dashboard.selector</field>
        <field name="arch" type="xml">
            <form string="Analytics Dashboard">
                <header>
                    <button string="📊 Ver Dashboard"
                            name="action_view_dashboard"
                            type="object"
                            class="oe_highlight"
                            invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')"/>
                    <button string="🔄 Actualizar Lista"
                            name="action_refresh_dashboards"
                            type="object"
                            class="btn-secondary"/>
                </header>
               
                <sheet>
                    <!-- Selector de dashboard -->
                    <group string="Seleccionar Dashboard">
                        <field name="selected_dashboard"/>
                    </group>
                   
                    <!-- DEBUG: Mostrar información -->
                    <group string="🔍 DEBUG - Información" invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')">
                        <field name="selected_dashboard" readonly="1" string="UUID Seleccionado"/>
                        <field name="dashboard_info" readonly="1" string="Info del Dashboard"/>
                    </group>
                   
                    <!-- Instrucciones -->
                    <div class="alert alert-info" invisible="selected_dashboard and selected_dashboard not in ('', 'no_config', 'no_dashboards', 'error')">
                        <p><strong>Instrucciones:</strong></p>
                        <ol>
                            <li>Selecciona un dashboard del desplegable</li>
                            <li>Haz clic en "📊 Ver Dashboard"</li>
                            <li>Se abrirá el visor completo</li>
                        </ol>
                    </div>
                   
                    <!-- Test: Botón alternativo más visible -->
                    <div invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')">
                        <hr/>
                        <div class="text-center">
                            <button string="🚀 ABRIR DASHBOARD"
                                    name="action_view_dashboard"
                                    type="object"
                                    class="btn btn-primary btn-lg"/>
                        </div>
                    </div>
                   
                </sheet>
            </form>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- ACCIONES MEJORADAS               -->
    <!-- ================================= -->
   
<record id="action_superset_dashboard_selector" model="ir.actions.act_window">
        <field name="name">Selector de Analytics</field>
        <field name="res_model">superset.dashboard.selector</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="view_id" ref="view_superset_dashboard_selector_form"/>
    </record>
   
    <record id="action_superset_dashboard_viewer" model="ir.actions.act_window">
        <field name="name">Dashboard Viewer</field>
        <field name="res_model">superset.dashboard.viewer</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="view_id" ref="view_superset_dashboard_viewer_form"/>
    </record>
 
</odoo>