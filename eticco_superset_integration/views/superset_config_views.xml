<?xml version="1.0" encoding="utf-8"?>
<odoo>
   
    <!-- ================================= -->
    <!-- CONFIGURACI√ìN MEJORADA EN SETTINGS -->
    <!-- ================================= -->
   
    <record id="res_config_settings_view_form_inherit_superset" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.superset</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <div name="eticco_superset_integration" string="Superset Integration">
                   
                    <!-- Secci√≥n: Conexi√≥n -->
                    <block title="Conexi√≥n a Superset" help="Configure la conexi√≥n con el servidor Apache Superset">
                        <setting string="URL del Servidor">
                            <field name="superset_url" placeholder="http://192.168.1.137:8088"/>
                            <div class="text-muted">
                                URL completa del servidor Superset (incluir puerto si es necesario)
                            </div>
                        </setting>
                       
                        <setting string="Credenciales de Acceso">
                            <div class="row">
                                <div class="col-6">
                                    <field name="superset_username" placeholder="admin"/>
                                </div>
                                <div class="col-6">
                                    <field name="superset_password" password="True" placeholder="admin"/>
                                </div>
                            </div>
                            <div class="text-muted">
                                Usuario administrador con permisos de acceso a la API
                            </div>
                        </setting>
                       
                        <setting string="Configuraci√≥n Avanzada">
                            <div class="row">
                                <div class="col-6">
                                    <label class="o_form_label" for="superset_timeout">Timeout (segundos)</label>
                                    <field name="superset_timeout"/>
                                </div>
                                <div class="col-6">
                                    <field name="superset_cache_tokens"/>
                                    <label for="superset_cache_tokens" class="o_form_label">Cache de tokens</label>
                                </div>
                            </div>
                            <div class="text-muted">
                                Timeout para conexiones y cache de tokens para mejor performance
                            </div>
                        </setting>
                       
                        <setting string="Estado de Conexi√≥n">
                            <div class="d-flex align-items-center">
                                <button name="test_superset_connection"
                                        string="üîç Probar Conexi√≥n"
                                        type="object"
                                        class="btn btn-primary me-2"/>
                                <button name="clear_superset_cache"
                                        string="üóëÔ∏è Limpiar Cache"
                                        type="object"
                                        class="btn btn-secondary me-2"/>
                                <button name="open_superset_dashboards"
                                        string="üìä Ver Dashboards"
                                        type="object"
                                        class="btn btn-info"/>
                            </div>
                            <div class="text-muted mt-2">
                                Estado: <field name="superset_connection_status" readonly="1" class="fw-bold"/>
                            </div>
                            <div class="row mt-2" invisible="superset_dashboards_count == 0">
                                <div class="col-6">
                                    <small class="text-muted">Dashboards totales:</small>
                                    <field name="superset_dashboards_count" readonly="1" class="fw-bold text-primary"/>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Con embedding:</small>
                                    <field name="superset_embedding_count" readonly="1" class="fw-bold text-success"/>
                                </div>
                            </div>
                        </setting>
                    </block>
                   
                    <!-- Secci√≥n: Configuraci√≥n del Men√∫ -->
                    <block title="Configuraci√≥n del Men√∫" help="Configure d√≥nde aparecer√°n los dashboards en Odoo">
                        <setting string="Ubicaci√≥n del Men√∫">
                            <field name="superset_menu_parent"
                                   options="{'no_create': True, 'no_edit': True}"
                                   placeholder="Selecciona men√∫ padre..."/>
                            <div class="text-muted">
                                Men√∫ donde se crear√° el acceso a dashboards de Superset
                            </div>
                        </setting>
                       
                        <setting string="Nombre del Men√∫">
                            <field name="superset_menu_name" placeholder="Analytics"/>
                            <div class="text-muted">
                                Nombre que tendr√° el men√∫ de dashboards en Odoo
                            </div>
                        </setting>
                       
                        <setting string="Crear Men√∫">
                            <button name="create_dashboard_menu"
                                    string="üéØ Crear Men√∫ de Dashboards"
                                    type="object"
                                    class="btn btn-success"/>
                            <div class="text-muted">
                                Crear el men√∫ en la ubicaci√≥n seleccionada
                            </div>
                        </setting>
                    </block>
                   
                    <!-- Secci√≥n: Debugging -->
                    <block title="Debugging y Desarrollo" help="Herramientas para desarrolladores">
                        <setting string="Modo Debug">
                            <field name="superset_debug_mode"/>
                            <div class="text-muted">
                                Activar logging detallado para identificar problemas
                            </div>
                        </setting>
                    </block>
                   
                </div>
            </xpath>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- VISOR DE DASHBOARDS MEJORADO    -->
    <!-- ================================= -->
   
  <record id="view_superset_dashboard_viewer_form" model="ir.ui.view">
        <field name="name">superset.dashboard.viewer.form</field>
        <field name="model">superset.dashboard.viewer</field>
        <field name="arch" type="xml">
            <form string="Dashboard Superset" create="false" edit="false" delete="false">
                <header>
                    <button string="üîó Abrir en Superset"
                            name="action_open_in_superset"
                            type="object"
                            class="btn-primary"/>
                </header>
               
                <sheet>
                    <!-- DEBUG: Mostrar informaci√≥n del viewer -->
                    <group string="üîç DEBUG - Dashboard Viewer" invisible="not dashboard_uuid">
                        <field name="dashboard_uuid" readonly="1" string="UUID del Dashboard"/>
                        <field name="dashboard_title" readonly="1" string="T√≠tulo"/>
                    </group>
                   
                    <!-- Dashboard embebido via iframe -->
                    <div invisible="not dashboard_uuid">
                        <h3>üìä Dashboard: <field name="dashboard_title" readonly="1" nolabel="1"/></h3>
                        <!-- Bot√≥n para abrir dashboard en nueva ventana -->
                        <div class="text-center mt-3">
                            <button type="object"
                                    name="open_dashboard_window"
                                    string="üöÄ Abrir Dashboard"
                                    class="btn btn-primary btn-lg"/>
                        </div>
                        <div class="text-muted text-center mt-2">
                            <small>El dashboard se abrir√° en la misma ventana</small>
                        </div>
                    </div>
                   
                    <!-- Mensaje si no hay UUID -->
                    <div class="alert alert-warning" invisible="dashboard_uuid">
                        <h5>‚ö†Ô∏è No hay dashboard configurado</h5>
                        <p>Este visor necesita recibir un dashboard_uuid.</p>
                    </div>
                   
                </sheet>
            </form>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- SELECTOR COMPLETO DE DASHBOARD      -->
    <!-- ================================= -->
   
   <record id="view_superset_dashboard_selector_form" model="ir.ui.view">
        <field name="name">superset.dashboard.selector.form</field>
        <field name="model">superset.dashboard.selector</field>
        <field name="arch" type="xml">
            <form string="Analytics Dashboard">
                <header>
                    <button string="üìä Ver Dashboard"
                            name="action_view_dashboard"
                            type="object"
                            class="oe_highlight"
                            invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')"/>
                    <button string="üîÑ Actualizar Lista"
                            name="action_refresh_dashboards"
                            type="object"
                            class="btn-secondary"/>
                </header>
               
                <sheet>
                    <!-- Selector de dashboard -->
                    <group string="Seleccionar Dashboard">
                        <field name="selected_dashboard"/>
                    </group>
                   
                    <!-- DEBUG: Mostrar informaci√≥n -->
                    <group string="üîç DEBUG - Informaci√≥n" invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')">
                        <field name="selected_dashboard" readonly="1" string="UUID Seleccionado"/>
                        <field name="dashboard_info" readonly="1" string="Info del Dashboard"/>
                    </group>
                   
                    <!-- Instrucciones -->
                    <div class="alert alert-info" invisible="selected_dashboard and selected_dashboard not in ('', 'no_config', 'no_dashboards', 'error')">
                        <p><strong>Instrucciones:</strong></p>
                        <ol>
                            <li>Selecciona un dashboard del desplegable</li>
                            <li>Haz clic en "üìä Ver Dashboard"</li>
                            <li>Se abrir√° el visor completo</li>
                        </ol>
                    </div>
                   
                    <!-- Test: Bot√≥n alternativo m√°s visible -->
                    <div invisible="not selected_dashboard or selected_dashboard in ('', 'no_config', 'no_dashboards', 'error')">
                        <hr/>
                        <div class="text-center">
                            <button string="üöÄ ABRIR DASHBOARD"
                                    name="action_view_dashboard"
                                    type="object"
                                    class="btn btn-primary btn-lg"/>
                        </div>
                    </div>
                   
                </sheet>
            </form>
        </field>
    </record>
 
    <!-- ================================= -->
    <!-- ACCIONES MEJORADAS               -->
    <!-- ================================= -->
   
<record id="action_superset_dashboard_selector" model="ir.actions.act_window">
        <field name="name">Selector de Analytics</field>
        <field name="res_model">superset.dashboard.selector</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="view_id" ref="view_superset_dashboard_selector_form"/>
    </record>
   
    <record id="action_superset_dashboard_viewer" model="ir.actions.act_window">
        <field name="name">Dashboard Viewer</field>
        <field name="res_model">superset.dashboard.viewer</field>
        <field name="view_mode">form</field>
        <field name="target">current</field>
        <field name="view_id" ref="view_superset_dashboard_viewer_form"/>
    </record>
 
</odoo>