<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="dashboard_page" name="Dashboard Superset">
        <html>
        <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title><t t-esc="dashboard_title"/> - Superset Dashboard</title>
            <script src="https://unpkg.com/@superset-ui/embedded-sdk@0.2.0"></script>
            <style>
                body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
                .loading-overlay {
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background: rgba(255,255,255,0.9); display: flex;
                    align-items: center; justify-content: center; z-index: 9999;
                }
                .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3;
                    border-top: 4px solid #007bff; border-radius: 50%;
                    animation: spin 1s linear infinite; }
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                #superset-container { width: 100%; height: 100vh; }
            </style>
        </head>
        <body>
            <div id="loading-overlay" class="loading-overlay">
                <div style="text-align: center;">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px;">Cargando dashboard...</p>
                </div>
            </div>
            <div id="superset-container"></div>
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', async function() {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    const container = document.getElementById('superset-container');
                    try {
                        console.log('Iniciando embedding de dashboard');
                        console.log('Dashboard Title:', '<t t-esc="dashboard_title"/>');
                        console.log('Embedding UUID:', '<t t-esc="dashboard_uuid"/>');
                        console.log('Superset URL:', '<t t-esc="superset_url"/>');
                        console.log('Guest Token disponible:', '<t t-esc="guest_token"/>' ? 'SÍ' : 'NO');
                        console.log('Guest Token (primeros 50 chars):', '<t t-esc="guest_token"/>'.substring(0, 50) + '...');
                        if (!window.supersetEmbeddedSdk) {
                            throw new Error('SDK de Superset no disponible');
                        }
                        console.log('SDK de Superset cargado');
                        const embedConfig = {
                            id: '<t t-esc="dashboard_uuid"/>',
                            supersetDomain: '<t t-esc="superset_url"/>',
                            mountPoint: container,
                            fetchGuestToken: () => '<t t-esc="guest_token"/>',
                            dashboardUiConfig: {
                                hideTitle: false,
                                hideTab: false,
                                hideChartControls: false,
                                hideFilters: false,
                            }
                        };
                        console.log('Configuración embedding:', {
                            id: embedConfig.id,
                            supersetDomain: embedConfig.supersetDomain,
                            mountPoint: !!embedConfig.mountPoint,
                            hasGuestToken: !!embedConfig.fetchGuestToken()
                        });
                        loadingOverlay.style.display = 'none';
                        const dashboard = await window.supersetEmbeddedSdk.embedDashboard(embedConfig);
                        console.log('Dashboard embebido exitosamente:', dashboard);
                        setTimeout(() => {
                            const iframe = container.querySelector('iframe');
                            if (iframe) {
                                iframe.style.width = '100%';
                                iframe.style.height = '100vh';
                                iframe.style.border = 'none';
                                console.log('Iframe ajustado');
                            } else {
                                console.warn('No se encontró iframe en el container');
                            }
                        }, 2000);
                    } catch (error) {
                        console.error('Error embebiendo dashboard:', error);
                        loadingOverlay.style.display = 'none';
                        container.innerHTML = 
                            '<div style="padding: 50px; text-align: center; font-family: Arial, sans-serif;">' +
                            '<h3 style="color: #dc3545;">Error cargando dashboard</h3>' +
                            '<p><strong>Error:</strong> ' + error.message + '</p>' +
                            '<hr style="margin: 20px 0;"/>' +
                            '<h4>Información de Debug:</h4>' +
                            '<div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">' +
                            '<p><strong>Embedding UUID:</strong> <t t-esc="dashboard_uuid"/></p>' +
                            '<p><strong>Superset URL:</strong> <t t-esc="superset_url"/></p>' +
                            '<p><strong>Dashboard Title:</strong> <t t-esc="dashboard_title"/></p>' +
                            '<p><strong>Guest Token:</strong> ' + ('<t t-esc="guest_token"/>' ? 'Disponible' : 'No disponible') + '</p>' +
                            '</div>' +
                            '<button onclick="window.location.reload();" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Reintentar</button>' +
                            '</div>';
                    }
                });
                window.supersetDebugInfo = {
                    embeddingUuid: '<t t-esc="dashboard_uuid"/>',
                    supersetUrl: '<t t-esc="superset_url"/>',
                    dashboardTitle: '<t t-esc="dashboard_title"/>',
                    hasGuestToken: '<t t-esc="guest_token"/>' ? true : false
                };
                console.log('Debug info disponible en window.supersetDebugInfo');
            </script>
        </body>
        </html>
    </template>
</odoo>